# Sunday.com Database Configuration
# Production-ready PostgreSQL configuration for enterprise workloads

# Environment-specific settings
environments:
  development:
    host: localhost
    port: 5432
    database: sunday_dev
    user: sunday_dev
    password: dev_password123
    sslmode: prefer
    pool_size: 10
    max_connections: 20

  test:
    host: localhost
    port: 5432
    database: sunday_test
    user: sunday_test
    password: test_password123
    sslmode: prefer
    pool_size: 5
    max_connections: 10

  staging:
    host: staging-db.sunday.com
    port: 5432
    database: sunday_staging
    user: sunday_staging
    password: ${STAGING_DB_PASSWORD}
    sslmode: require
    pool_size: 20
    max_connections: 50

  production:
    host: prod-db.sunday.com
    port: 5432
    database: sunday_prod
    user: sunday_prod
    password: ${PROD_DB_PASSWORD}
    sslmode: require
    pool_size: 50
    max_connections: 200

# Connection pool settings
connection_pool:
  min_connections: 5
  max_connections: 200
  connection_timeout: 30
  idle_timeout: 300
  acquire_timeout: 30
  validation_query: "SELECT 1"
  test_on_borrow: true

# Performance tuning parameters
performance:
  # Memory settings
  shared_buffers: "256MB"  # 25% of RAM for dedicated DB server
  effective_cache_size: "1GB"  # 75% of RAM
  work_mem: "4MB"  # Per connection working memory
  maintenance_work_mem: "64MB"  # For maintenance operations

  # WAL settings
  wal_buffers: "16MB"
  wal_level: "replica"  # For replication
  max_wal_size: "1GB"
  min_wal_size: "80MB"
  checkpoint_completion_target: 0.7
  checkpoint_timeout: "5min"

  # Query planning
  random_page_cost: 1.1  # SSD optimized
  effective_io_concurrency: 200  # SSD parallel I/O
  default_statistics_target: 100
  constraint_exclusion: "partition"

  # Parallel query settings
  max_parallel_workers_per_gather: 4
  max_parallel_workers: 8
  max_worker_processes: 16
  parallel_tuple_cost: 0.1
  parallel_setup_cost: 1000

  # Connection settings
  max_connections: 200
  superuser_reserved_connections: 3

  # Logging settings
  log_destination: "stderr"
  logging_collector: true
  log_directory: "/var/log/postgresql"
  log_filename: "postgresql-%Y-%m-%d_%H%M%S.log"
  log_rotation_age: "1d"
  log_rotation_size: "10MB"
  log_min_duration_statement: 1000  # Log queries > 1s
  log_checkpoints: true
  log_connections: true
  log_disconnections: true
  log_lock_waits: true
  log_statement: "mod"  # Log DDL and DML

  # Monitoring
  track_activities: true
  track_counts: true
  track_io_timing: true
  track_functions: "all"
  stats_temp_directory: "/var/run/postgresql/stats_temp"

# Backup configuration
backup:
  # Local backup settings
  local_backup_dir: "/var/backups/sunday"
  compression_level: 9
  encryption_enabled: true
  encryption_key_file: "/etc/sunday/backup_encryption.key"

  # S3 backup settings
  s3_bucket: "sunday-db-backups"
  s3_region: "us-east-1"
  s3_storage_class: "STANDARD_IA"
  s3_encryption: "AES256"

  # Backup schedules
  full_backup_schedule: "0 2 * * 0"  # Sunday 2 AM
  incremental_backup_schedule: "0 2 * * 1-6"  # Monday-Saturday 2 AM
  cleanup_schedule: "0 3 1 * *"  # Monthly cleanup

  # Retention policy
  retention_days:
    full_backups: 90
    incremental_backups: 30
    archived_logs: 7

# Monitoring and alerting
monitoring:
  # Performance thresholds
  query_time_threshold_ms: 1000
  connection_threshold_percent: 80
  cache_hit_ratio_threshold: 90
  disk_usage_threshold_percent: 85

  # Health check settings
  health_check_interval: 60  # seconds
  health_check_timeout: 10   # seconds

  # Metrics collection
  pg_stat_statements:
    enabled: true
    track: "all"
    max: 10000
    track_utility: false

  # Alert channels
  alerts:
    email: ["dba@sunday.com", "ops@sunday.com"]
    slack_webhook: "${SLACK_WEBHOOK_URL}"
    pagerduty_key: "${PAGERDUTY_INTEGRATION_KEY}"

# Security settings
security:
  # SSL/TLS configuration
  ssl: true
  ssl_cert_file: "/etc/ssl/certs/sunday-db.crt"
  ssl_key_file: "/etc/ssl/private/sunday-db.key"
  ssl_ca_file: "/etc/ssl/certs/ca-bundle.crt"
  ssl_ciphers: "ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS"
  ssl_prefer_server_ciphers: true

  # Authentication
  password_encryption: "scram-sha-256"
  krb_server_keyfile: "/etc/postgresql/krb5.keytab"

  # Access control
  default_privileges: "USAGE"
  row_security: true

  # Audit logging
  audit_log_enabled: true
  audit_log_directory: "/var/log/postgresql/audit"
  audit_log_file: "audit-%Y-%m-%d.log"

# Replication settings
replication:
  # Master configuration
  master:
    host: "prod-db-master.sunday.com"
    port: 5432
    replication_user: "replicator"
    replication_password: "${REPLICATION_PASSWORD}"

  # Replica configuration
  replicas:
    - name: "replica-1"
      host: "prod-db-replica1.sunday.com"
      port: 5432
      lag_threshold_mb: 100

    - name: "replica-2"
      host: "prod-db-replica2.sunday.com"
      port: 5432
      lag_threshold_mb: 100

  # Replication settings
  max_wal_senders: 3
  wal_keep_segments: 32
  hot_standby: true
  hot_standby_feedback: true
  max_standby_streaming_delay: "30s"

# Partitioning configuration
partitioning:
  # Partition management
  auto_create_partitions: true
  partition_retention_months:
    activity_log: 24
    automation_executions: 12
    webhook_deliveries: 6

  # Partition maintenance
  maintenance_schedule: "0 1 * * *"  # Daily at 1 AM
  vacuum_analyze_partitions: true

  # Partition monitoring
  size_threshold_gb: 10
  alert_on_large_partitions: true

# Sharding configuration
sharding:
  # Shard distribution
  enabled: false  # Enable when scaling beyond single server
  shard_count: 4
  hash_function: "md5"

  # Shard servers
  shards:
    - id: 1
      host: "shard1.sunday.com"
      port: 5432
      weight: 1.0

    - id: 2
      host: "shard2.sunday.com"
      port: 5432
      weight: 1.0

    - id: 3
      host: "shard3.sunday.com"
      port: 5432
      weight: 1.0

    - id: 4
      host: "shard4.sunday.com"
      port: 5432
      weight: 1.0

  # Cross-shard operations
  allow_cross_shard_queries: false
  federation_enabled: false

# Maintenance windows
maintenance:
  # Scheduled maintenance
  weekly_maintenance:
    day: "sunday"
    start_time: "01:00"
    duration_hours: 2

  monthly_maintenance:
    day: "first_sunday"
    start_time: "01:00"
    duration_hours: 4

  # Emergency maintenance
  emergency_contact: "+1-555-0123"
  escalation_time_minutes: 15

# Feature flags
features:
  # Advanced features
  enable_parallel_query: true
  enable_jit: false  # Enable for CPU-intensive workloads
  enable_partition_wise_joins: true
  enable_partition_wise_aggregates: true

  # Extensions
  extensions:
    - "uuid-ossp"
    - "pg_trgm"
    - "btree_gin"
    - "pg_stat_statements"
    - "postgres_fdw"  # For potential sharding

  # Experimental features
  enable_experimental_features: false

# Disaster recovery
disaster_recovery:
  # RTO/RPO targets
  recovery_time_objective_minutes: 30
  recovery_point_objective_minutes: 5

  # DR site configuration
  dr_site:
    enabled: true
    location: "us-west-2"
    host: "dr-db.sunday.com"
    replication_lag_threshold_seconds: 30

  # Failover procedures
  automatic_failover: false  # Manual approval required
  failover_script: "/opt/sunday/scripts/failover.sh"
  notification_channels: ["email", "slack", "pagerduty"]

  # Testing schedule
  dr_test_schedule: "0 2 1 * *"  # Monthly on 1st at 2 AM
  test_duration_hours: 2

# Development tools
development:
  # Query analysis
  enable_query_logging: true
  explain_analyze_auto: false

  # Schema tools
  migration_path: "/opt/sunday/database/migrations"
  seed_data_path: "/opt/sunday/database/seeds"

  # Testing
  test_database_template: "sunday_test_template"
  reset_test_data: true