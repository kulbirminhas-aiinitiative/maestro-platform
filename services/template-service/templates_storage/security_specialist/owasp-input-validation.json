{
  "metadata": {
    "id": "owasp-input-validation-v1",
    "name": "OWASP Input Validation & Sanitization",
    "category": "security",
    "language": "typescript",
    "framework": "express",
    "description": "Production-ready input validation, sanitization, and XSS/SQL injection prevention following OWASP guidelines",
    "tags": ["security", "owasp", "input-validation", "xss-prevention", "sql-injection", "sanitization"],
    "quality_score": 93.0,
    "security_score": 98.0,
    "performance_score": 85.0,
    "maintainability_score": 88.0,
    "test_coverage": 90.0,
    "usage_count": 0,
    "success_rate": 0.0,
    "status": "approved",
    "created_at": "2025-10-04T20:00:00.000000",
    "updated_at": "2025-10-04T20:00:00.000000",
    "created_by": "template_enhancement_phase1",
    "persona": "security_specialist"
  },
  "content": "import express, { Request, Response, NextFunction } from 'express';\nimport { body, param, query, validationResult, ValidationChain } from 'express-validator';\nimport DOMPurify from 'isomorphic-dompurify';\nimport { escape } from 'html-escaper';\nimport rateLimit from 'express-rate-limit';\nimport helmet from 'helmet';\nimport { z } from 'zod';\n\n// OWASP Input Validation Middleware\nexport class InputValidator {\n  // SQL Injection Prevention\n  static sanitizeSQL(input: string): string {\n    // Remove dangerous SQL characters\n    return input.replace(/[';\"\\\\]/g, '');\n  }\n\n  // XSS Prevention\n  static sanitizeHTML(input: string, allowedTags: string[] = []): string {\n    const config = {\n      ALLOWED_TAGS: allowedTags,\n      ALLOWED_ATTR: [],\n      KEEP_CONTENT: true,\n    };\n    return DOMPurify.sanitize(input, config);\n  }\n\n  // Path Traversal Prevention\n  static sanitizePath(input: string): string {\n    return input.replace(/\\.\\.[\\/\\\\]/g, '').replace(/^[\\/\\\\]/, '');\n  }\n\n  // Command Injection Prevention\n  static sanitizeCommand(input: string): string {\n    return input.replace(/[;&|`$(){}\\[\\]<>]/g, '');\n  }\n\n  // Email validation\n  static isValidEmail(email: string): boolean {\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n    return emailRegex.test(email) && email.length <= 254;\n  }\n\n  // URL validation with whitelist\n  static isValidURL(url: string, allowedDomains: string[] = []): boolean {\n    try {\n      const parsed = new URL(url);\n      \n      // Check protocol\n      if (!['http:', 'https:'].includes(parsed.protocol)) {\n        return false;\n      }\n      \n      // Check domain whitelist\n      if (allowedDomains.length > 0) {\n        return allowedDomains.some(domain => parsed.hostname.endsWith(domain));\n      }\n      \n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Phone number validation\n  static isValidPhone(phone: string): boolean {\n    const phoneRegex = /^\\+?[1-9]\\d{1,14}$/;\n    return phoneRegex.test(phone.replace(/[\\s()-]/g, ''));\n  }\n\n  // Credit card validation (Luhn algorithm)\n  static isValidCreditCard(number: string): boolean {\n    const cleaned = number.replace(/\\s/g, '');\n    if (!/^\\d{13,19}$/.test(cleaned)) return false;\n    \n    let sum = 0;\n    let isEven = false;\n    \n    for (let i = cleaned.length - 1; i >= 0; i--) {\n      let digit = parseInt(cleaned[i]);\n      \n      if (isEven) {\n        digit *= 2;\n        if (digit > 9) digit -= 9;\n      }\n      \n      sum += digit;\n      isEven = !isEven;\n    }\n    \n    return sum % 10 === 0;\n  }\n}\n\n// Express Validator Chains\nexport const userValidation = {\n  register: [\n    body('email')\n      .trim()\n      .isEmail().withMessage('Invalid email format')\n      .normalizeEmail()\n      .isLength({ max: 254 }).withMessage('Email too long'),\n    \n    body('password')\n      .isLength({ min: 12 }).withMessage('Password must be at least 12 characters')\n      .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]/).withMessage(\n        'Password must contain uppercase, lowercase, number, and special character'\n      ),\n    \n    body('name')\n      .trim()\n      .isLength({ min: 2, max: 100 }).withMessage('Name must be 2-100 characters')\n      .matches(/^[a-zA-Z\\s'-]+$/).withMessage('Name contains invalid characters')\n      .customSanitizer((value) => InputValidator.sanitizeHTML(value, [])),\n    \n    body('phone')\n      .optional()\n      .custom((value) => InputValidator.isValidPhone(value))\n      .withMessage('Invalid phone number'),\n  ],\n  \n  updateProfile: [\n    body('bio')\n      .optional()\n      .isLength({ max: 500 }).withMessage('Bio too long')\n      .customSanitizer((value) => InputValidator.sanitizeHTML(value, ['b', 'i', 'u', 'a'])),\n    \n    body('website')\n      .optional()\n      .custom((value) => InputValidator.isValidURL(value))\n      .withMessage('Invalid URL'),\n  ],\n};\n\n// Zod Schemas for Type-Safe Validation\nconst userSchema = z.object({\n  email: z.string().email().max(254),\n  password: z.string().min(12).regex(\n    /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]+$/,\n    'Password requirements not met'\n  ),\n  name: z.string().min(2).max(100).regex(/^[a-zA-Z\\s'-]+$/),\n  phone: z.string().regex(/^\\+?[1-9]\\d{1,14}$/).optional(),\n}).transform((data) => ({\n  ...data,\n  email: data.email.toLowerCase().trim(),\n  name: InputValidator.sanitizeHTML(data.name, []),\n}));\n\n// Validation Middleware\nexport function validate(validations: ValidationChain[]) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    // Run all validations\n    await Promise.all(validations.map((validation) => validation.run(req)));\n    \n    const errors = validationResult(req);\n    \n    if (errors.isEmpty()) {\n      return next();\n    }\n    \n    // Log validation failures for security monitoring\n    console.warn('Validation failed:', {\n      ip: req.ip,\n      path: req.path,\n      errors: errors.array(),\n    });\n    \n    res.status(400).json({\n      error: 'Validation failed',\n      details: errors.array().map(err => ({\n        field: err.param,\n        message: err.msg,\n      })),\n    });\n  };\n}\n\n// Content Security Policy\nexport function setupSecurityHeaders(app: express.Application) {\n  app.use(helmet({\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        scriptSrc: [\"'self'\", \"'unsafe-inline'\"],  // Avoid 'unsafe-inline' in production\n        styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n        imgSrc: [\"'self'\", 'data:', 'https:'],\n        connectSrc: [\"'self'\"],\n        fontSrc: [\"'self'\"],\n        objectSrc: [\"'none'\"],\n        mediaSrc: [\"'self'\"],\n        frameSrc: [\"'none'\"],\n      },\n    },\n    hsts: {\n      maxAge: 31536000,\n      includeSubDomains: true,\n      preload: true,\n    },\n    noSniff: true,\n    xssFilter: true,\n    referrerPolicy: { policy: 'strict-origin-when-cross-origin' },\n  }));\n}\n\n// File Upload Validation\nexport const fileUploadValidation = {\n  image: {\n    allowedMimeTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],\n    maxSize: 5 * 1024 * 1024, // 5MB\n  },\n  document: {\n    allowedMimeTypes: ['application/pdf', 'application/msword'],\n    maxSize: 10 * 1024 * 1024, // 10MB\n  },\n};\n\nexport function validateFileUpload(type: 'image' | 'document') {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.file) {\n      return res.status(400).json({ error: 'No file uploaded' });\n    }\n    \n    const config = fileUploadValidation[type];\n    \n    // Validate MIME type\n    if (!config.allowedMimeTypes.includes(req.file.mimetype)) {\n      return res.status(400).json({ error: 'Invalid file type' });\n    }\n    \n    // Validate file size\n    if (req.file.size > config.maxSize) {\n      return res.status(400).json({ error: 'File too large' });\n    }\n    \n    // Validate filename\n    const sanitizedFilename = InputValidator.sanitizePath(req.file.originalname);\n    req.file.originalname = sanitizedFilename;\n    \n    next();\n  };\n}\n\n// Rate Limiting per Input Type\nexport const rateLimiters = {\n  // Strict rate limiting for sensitive operations\n  auth: rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    max: 5, // 5 attempts\n    message: 'Too many authentication attempts',\n    standardHeaders: true,\n    legacyHeaders: false,\n  }),\n  \n  // General API rate limiting\n  api: rateLimit({\n    windowMs: 1 * 60 * 1000, // 1 minute\n    max: 100,\n    message: 'Too many requests',\n  }),\n};\n\n// Usage Example\nconst app = express();\n\n// Setup security headers\nsetupSecurityHeaders(app);\n\n// Apply rate limiting\napp.use('/api/auth', rateLimiters.auth);\napp.use('/api', rateLimiters.api);\n\n// Routes with validation\napp.post(\n  '/api/users/register',\n  validate(userValidation.register),\n  async (req: Request, res: Response) => {\n    const { email, password, name, phone } = req.body;\n    \n    // Additional server-side validation with Zod\n    const result = userSchema.safeParse(req.body);\n    \n    if (!result.success) {\n      return res.status(400).json({ error: result.error.errors });\n    }\n    \n    // Safe to use validated data\n    const validatedData = result.data;\n    \n    // Process registration...\n    res.json({ message: 'User registered successfully' });\n  }\n);\n\nexport default app;",
  "variables": {},
  "dependencies": [
    "express@^4.18.2",
    "express-validator@^7.0.1",
    "isomorphic-dompurify@^2.2.0",
    "html-escaper@^3.0.3",
    "express-rate-limit@^7.1.5",
    "helmet@^7.1.0",
    "zod@^3.22.4"
  ],
  "workflow_context": {
    "typical_use_cases": [
      "OWASP Top 10 prevention",
      "Input validation and sanitization",
      "XSS and SQL injection prevention",
      "File upload security",
      "API rate limiting"
    ],
    "team_composition": ["security_specialist", "backend_developer"],
    "estimated_time_minutes": 65,
    "prerequisites": [
      "Understanding of OWASP Top 10",
      "Express.js knowledge",
      "Security best practices",
      "CSP configuration"
    ],
    "related_templates": [
      "authentication-security",
      "api-security-checklist",
      "secure-file-upload"
    ]
  }
}
