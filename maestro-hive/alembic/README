Alembic Database Migrations
============================

This directory contains Alembic database migration scripts for the Maestro DAG workflow system.

## Setup

1. Install dependencies:
   ```bash
   pip install alembic psycopg2-binary
   ```

2. Configure PostgreSQL connection in environment variables:
   ```bash
   export POSTGRES_HOST=localhost
   export POSTGRES_PORT=5432
   export POSTGRES_DB=maestro_workflows
   export POSTGRES_USER=maestro
   export POSTGRES_PASSWORD=maestro_dev
   ```

   Or use SQLite for development:
   ```bash
   export USE_SQLITE=true
   export SQLITE_PATH=maestro_workflows.db
   ```

## Usage

### Initialize database (first time)
```bash
# Create initial migration
alembic revision --autogenerate -m "Initial schema"

# Apply migrations
alembic upgrade head
```

### Create new migration
```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply migrations
```bash
# Upgrade to latest
alembic upgrade head

# Upgrade one version
alembic upgrade +1

# Downgrade one version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade <revision_id>
```

### Check current version
```bash
alembic current
```

### View migration history
```bash
alembic history
```

## Migration Best Practices

1. **Always review autogenerated migrations** before applying
2. **Test migrations** in development before production
3. **Backup database** before running migrations in production
4. **Keep migrations small** and focused on one change
5. **Don't modify** existing migration files after they've been applied

## Troubleshooting

### Connection refused
- Ensure PostgreSQL is running: `sudo systemctl status postgresql`
- Check connection settings in environment variables

### Migration conflicts
- Check current version: `alembic current`
- View history: `alembic history`
- Resolve conflicts manually if needed

### Reset database (development only)
```bash
# WARNING: This deletes all data
python database/config.py reset
```

## File Structure

```
alembic/
├── env.py              # Migration environment configuration
├── script.py.mako      # Migration template
├── versions/           # Migration scripts (auto-generated)
│   └── *.py
└── README             # This file
```
