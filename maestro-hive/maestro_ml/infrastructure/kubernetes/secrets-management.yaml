# External Secrets Operator Setup
# Manages secrets from external sources (AWS Secrets Manager, Vault, etc.)

# Step 1: Install External Secrets Operator
# kubectl apply -f https://raw.githubusercontent.com/external-secrets/external-secrets/main/deploy/crds/bundle.yaml
# helm repo add external-secrets https://charts.external-secrets.io
# helm install external-secrets external-secrets/external-secrets -n external-secrets-system --create-namespace

---
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets-system

---
# SecretStore for AWS Secrets Manager (Production)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: aws-secrets-manager
  namespace: ml-platform
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa

---
# ServiceAccount for External Secrets (with IRSA for AWS)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: ml-platform
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/external-secrets-role

---
# ExternalSecret for MLflow credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: mlflow-credentials
  namespace: ml-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: mlflow-credentials
    creationPolicy: Owner
  data:
  - secretKey: database-password
    remoteRef:
      key: ml-platform/mlflow/database
      property: password
  - secretKey: s3-access-key
    remoteRef:
      key: ml-platform/mlflow/s3
      property: access_key
  - secretKey: s3-secret-key
    remoteRef:
      key: ml-platform/mlflow/s3
      property: secret_key

---
# ExternalSecret for Feast credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: feast-credentials
  namespace: ml-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: feast-credentials
    creationPolicy: Owner
  data:
  - secretKey: postgres-password
    remoteRef:
      key: ml-platform/feast/database
      property: password
  - secretKey: redis-password
    remoteRef:
      key: ml-platform/feast/redis
      property: password

---
# ExternalSecret for Airflow credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: airflow-credentials
  namespace: airflow
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: airflow-credentials
    creationPolicy: Owner
  data:
  - secretKey: postgres-password
    remoteRef:
      key: ml-platform/airflow/database
      property: password
  - secretKey: fernet-key
    remoteRef:
      key: ml-platform/airflow/fernet
      property: key
  - secretKey: webserver-secret-key
    remoteRef:
      key: ml-platform/airflow/webserver
      property: secret_key

---
# ExternalSecret for Harbor registry credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: harbor-credentials
  namespace: harbor-system
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: harbor-credentials
    creationPolicy: Owner
  data:
  - secretKey: admin-password
    remoteRef:
      key: ml-platform/harbor/admin
      property: password
  - secretKey: database-password
    remoteRef:
      key: ml-platform/harbor/database
      property: password
  - secretKey: core-secret
    remoteRef:
      key: ml-platform/harbor/core
      property: secret
  - secretKey: jobservice-secret
    remoteRef:
      key: ml-platform/harbor/jobservice
      property: secret

---
# ClusterSecretStore (available to all namespaces)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager-cluster
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets-system

---
# ExternalSecret for database credentials (shared)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials
  namespace: storage
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager-cluster
    kind: ClusterSecretStore
  target:
    name: postgres-credentials
    creationPolicy: Owner
  data:
  - secretKey: postgres-password
    remoteRef:
      key: ml-platform/shared/postgres
      property: password
  - secretKey: postgres-user
    remoteRef:
      key: ml-platform/shared/postgres
      property: user

---
# Sealed Secrets (Alternative for GitOps)
# Install: kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml

---
# Example SealedSecret for MLflow
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: mlflow-sealed-secret
  namespace: ml-platform
spec:
  encryptedData:
    database-password: AgB... # Encrypted with kubeseal
    s3-access-key: AgC...
    s3-secret-key: AgD...
  template:
    metadata:
      name: mlflow-credentials
      namespace: ml-platform

---
# RBAC for External Secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: external-secrets-role
  namespace: ml-platform
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
- apiGroups: ["external-secrets.io"]
  resources: ["externalsecrets", "secretstores"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: external-secrets-rolebinding
  namespace: ml-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: external-secrets-role
subjects:
- kind: ServiceAccount
  name: external-secrets-sa
  namespace: ml-platform

---
# Vault SecretStore (Alternative)
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: ml-platform
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "ml-platform"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "ml-platform"
          serviceAccountRef:
            name: external-secrets-sa

---
# Secret rotation policy
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: rotated-secret
  namespace: ml-platform
  annotations:
    reloader.stakater.com/match: "true"  # Auto-reload pods on secret change
spec:
  refreshInterval: 15m  # Check for updates every 15 minutes
  secretStoreRef:
    name: aws-secrets-manager
    kind: SecretStore
  target:
    name: rotated-secret
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
  - secretKey: api-key
    remoteRef:
      key: ml-platform/api-keys
      property: primary_key

---
# Secret access audit
apiVersion: audit.k8s.io/v1
kind: Policy
metadata:
  name: secret-access-audit
rules:
- level: RequestResponse
  verbs: ["get", "list", "watch"]
  resources:
  - group: ""
    resources: ["secrets"]
  namespaces: ["ml-platform", "airflow", "feast"]
