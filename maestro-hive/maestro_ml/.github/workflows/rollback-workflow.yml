name: Model Rollback
# Rollback to previous model version

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name'
        required: true
        type: string
      target_version:
        description: 'Target version to rollback to (leave empty for previous)'
        required: false
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: false
        type: string
        default: ml-serving

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Validate rollback target
  validate-rollback:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.get_current.outputs.version }}
      target_version: ${{ steps.get_target.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config

      - name: Get current deployment
        id: get_current
        run: |
          namespace="${{ github.event.inputs.namespace }}"
          model_name="${{ github.event.inputs.model_name }}"

          # Get current deployment
          current=$(kubectl get deployments -n "$namespace" \
            -l app=mlflow-serving,model="$model_name" \
            -o jsonpath='{.items[0].metadata.labels.version}')

          echo "Current version: $current"
          echo "version=$current" >> $GITHUB_OUTPUT

      - name: Get target version
        id: get_target
        run: |
          target="${{ github.event.inputs.target_version }}"

          if [ -z "$target" ]; then
            # Get previous version from rollout history
            deployment_name="${{ github.event.inputs.model_name }}"
            namespace="${{ github.event.inputs.namespace }}"

            # Get revision before current
            previous=$(kubectl rollout history deployment/"$deployment_name" \
              -n "$namespace" | tail -2 | head -1 | awk '{print $1}')

            echo "Target version: $previous (previous)"
            echo "version=$previous" >> $GITHUB_OUTPUT
          else
            echo "Target version: $target (specified)"
            echo "version=$target" >> $GITHUB_OUTPUT
          fi

  # Execute rollback
  execute-rollback:
    runs-on: ubuntu-latest
    needs: validate-rollback
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install mlflow scikit-learn pandas numpy pyyaml

      - name: Configure kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config

      - name: Perform rollback
        run: |
          model_name="${{ github.event.inputs.model_name }}"
          target_version="${{ github.event.inputs.target_version }}"
          namespace="${{ github.event.inputs.namespace }}"

          echo "Rolling back $model_name to version $target_version"

          python3 governance/deployment-automation.py rollback \
            --model-name "$model_name" \
            --target-version "$target_version" \
            --namespace "$namespace"

      - name: Verify rollback
        run: |
          model_name="${{ github.event.inputs.model_name }}"
          namespace="${{ github.event.inputs.namespace }}"

          kubectl rollout status deployment/"$model_name" -n "$namespace"

          echo "âœ“ Rollback complete"

  # Validate rollback
  post-rollback-checks:
    runs-on: ubuntu-latest
    needs: execute-rollback
    steps:
      - name: Health checks
        run: |
          model_name="${{ github.event.inputs.model_name }}"
          namespace="${{ github.event.inputs.namespace }}"

          # Get pod
          pod=$(kubectl get pods -n "$namespace" \
            -l app=mlflow-serving,model="$model_name" \
            -o jsonpath='{.items[0].metadata.name}')

          # Port forward
          kubectl port-forward -n "$namespace" "$pod" 8080:8080 &
          sleep 5

          # Health check
          response=$(curl -s http://localhost:8080/health)
          echo "Health check: $response"

          if echo "$response" | grep -q '"status":"healthy"'; then
            echo "âœ“ Rollback successful - service healthy"
          else
            echo "âœ— Rollback failed - service unhealthy"
            exit 1
          fi

      - name: Rollback notification
        run: |
          echo "ðŸ”„ Rollback completed successfully"
          echo "Model: ${{ github.event.inputs.model_name }}"
          echo "From version: ${{ needs.validate-rollback.outputs.current_version }}"
          echo "To version: ${{ needs.validate-rollback.outputs.target_version }}"
