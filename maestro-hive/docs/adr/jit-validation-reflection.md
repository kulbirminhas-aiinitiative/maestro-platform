# ADR: JIT Validation & Persona Reflection

## Status

Accepted

## Context

Architecture review identified the "Silent Workers" anti-pattern in the Maestro platform:
- Personas operate in single-shot mode without validation
- No syntax checking on generated code before delivery
- No test execution or reflection loops
- Agents get stuck without escalation mechanism

This leads to:
- Broken code delivered to downstream consumers
- No feedback loops for improvement
- Silent failures that propagate through the system

## Decision

We will implement a comprehensive JIT (Just-In-Time) validation and reflection system:

### 1. JIT Syntax Validation

Every Python file generated by a persona will be validated using `ast.parse()` immediately after generation.

```python
def validate_python_syntax(code: str, filename: str) -> ValidationResult:
    try:
        ast.parse(code)
        return ValidationResult(valid=True)
    except SyntaxError as e:
        return ValidationResult(
            valid=False,
            error=f"Syntax error at line {e.lineno}: {e.msg}"
        )
```

### 2. Generate → Test → Reflect → Refine Loop

Personas will follow a structured loop:

```
┌─────────────┐
│  Generate   │ ← Create initial code/artifact
└──────┬──────┘
       │
       v
┌─────────────┐
│    Test     │ ← Run syntax check + unit tests
└──────┬──────┘
       │
       v
┌─────────────┐
│   Reflect   │ ← Analyze failures, identify root cause
└──────┬──────┘
       │
       v
┌─────────────┐
│   Refine    │ ← Apply fixes based on reflection
└──────┬──────┘
       │
       v
    [Loop back if still failing, max 3 iterations]
```

### 3. Test Execution Tools

Personas will have access to:
- `run_pytest(test_file)` - Execute pytest on generated tests
- `run_syntax_check(file)` - AST validation
- `run_mypy(file)` - Type checking (optional)

### 4. HelpNeeded Exception

After exhausting retries (default: 3), personas raise `HelpNeeded`:

```python
class HelpNeeded(Exception):
    """Raised when a persona cannot complete a task after max retries."""

    def __init__(
        self,
        persona_id: str,
        task: str,
        attempts: int,
        last_error: str,
        context: dict
    ):
        self.persona_id = persona_id
        self.task = task
        self.attempts = attempts
        self.last_error = last_error
        self.context = context
        super().__init__(f"Persona '{persona_id}' needs help with '{task}' after {attempts} attempts")
```

## Consequences

### Positive
- Early detection of syntax errors before delivery
- Self-correcting personas that can fix their own mistakes
- Reduced downstream failures
- Clear escalation path when agents are stuck
- Better quality output through iteration

### Negative
- Increased execution time due to validation loops
- More token usage for reflection prompts
- Complexity in persona execution flow

### Risks Mitigated
- Broken code delivery: Caught by JIT validation
- Silent failures: HelpNeeded escalation
- Quality issues: Reflection loops improve output

## Implementation

### Phase 1: JIT Validator Module
- `src/maestro_hive/validation/jit_validator.py` - Core validation logic
- `src/maestro_hive/validation/syntax_checker.py` - AST-based syntax validation

### Phase 2: Reflection Engine
- `src/maestro_hive/validation/reflection_engine.py` - Analyze failures and suggest fixes
- Integration with persona execution flow

### Phase 3: Test Runner Integration
- `src/maestro_hive/validation/test_runner.py` - Execute tests within persona context
- Capture and report test results for reflection

### Phase 4: HelpNeeded Escalation
- `src/maestro_hive/validation/exceptions.py` - HelpNeeded and related exceptions
- Integration with team coordinator for escalation handling

## Files Changed

### Added
- `src/maestro_hive/validation/__init__.py`
- `src/maestro_hive/validation/jit_validator.py`
- `src/maestro_hive/validation/syntax_checker.py`
- `src/maestro_hive/validation/reflection_engine.py`
- `src/maestro_hive/validation/test_runner.py`
- `src/maestro_hive/validation/exceptions.py`

### Modified
- `persona_executor_v2.py` (integration with validation)

## References

- EPIC: MD-3092 - JIT Validation & Persona Reflection
- Related: MD-3094 - Token Efficiency & Cleanup (max_attempts config)
- Architecture Review: "Silent Workers" anti-pattern
