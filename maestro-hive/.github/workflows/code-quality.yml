# Maestro-Hive Code Quality Pipeline
# Epic: MD-1895 - Maestro-Hive CI/CD Implementation
# Task: MD-1897 - .github/workflows/code-quality.yml (validation)
#
# This workflow performs comprehensive code quality checks:
# - Legacy import blocking
# - TODO detection
# - Large file detection
# - Security scanning
# - Directory structure validation

name: Code Quality

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 mypy pyyaml

      - name: Check code formatting with Black
        run: |
          black --check --line-length=100 \
            tri_audit/ \
            ics/ \
            tests/tri_audit/ \
            --exclude='generated_|_legacy|_experiments'
        continue-on-error: false

      - name: Check import sorting with isort
        run: |
          isort --check --profile=black --line-length=100 \
            tri_audit/ \
            ics/ \
            tests/tri_audit/
        continue-on-error: false

      - name: Lint with flake8
        run: |
          flake8 tri_audit/ ics/ tests/tri_audit/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --exclude=generated_,_legacy,_experiments
        continue-on-error: false

      - name: Type check with mypy
        run: |
          mypy tri_audit/ --ignore-missing-imports || true
        continue-on-error: true  # Non-blocking for now

      - name: Check for TODOs in production code
        run: |
          echo "Checking for TODO/FIXME in production code..."
          if grep -rn "TODO\|FIXME" tri_audit/ ics/ --include="*.py" 2>/dev/null; then
            echo "::warning::Found TODO/FIXME in production code - please address before release"
          else
            echo "No TODO/FIXME found in production code"
          fi
        continue-on-error: true  # Warning only

      - name: Check for legacy imports
        run: |
          echo "Checking for imports from generated_* directories..."
          if grep -rn "from generated_\|import generated_" tri_audit/ ics/ --include="*.py" 2>/dev/null; then
            echo "::error::Found imports from generated_* directories - this is not allowed"
            exit 1
          else
            echo "No legacy imports found"
          fi
        continue-on-error: false

      - name: Check for large files
        run: |
          echo "Checking for large files (>1MB)..."
          large_files=$(find tri_audit/ ics/ tests/tri_audit/ -type f -size +1M 2>/dev/null)
          if [ -n "$large_files" ]; then
            echo "::error::Large files found:"
            echo "$large_files"
            exit 1
          fi
          echo "No large files found"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential hardcoded secrets..."
          patterns="password=|secret=|api_key=|token=|AWS_SECRET|ANTHROPIC_API_KEY="
          if grep -rEi "$patterns" tri_audit/ ics/ --include="*.py" | grep -v "# " | grep -v "os.environ" | grep -v "os.getenv"; then
            echo "::warning::Potential hardcoded secrets found - please review"
          else
            echo "No obvious secrets found"
          fi
        continue-on-error: true

      - name: Validate YAML files
        run: |
          echo "Validating YAML configuration files..."
          python -c "
          import yaml
          import glob
          import sys

          errors = []
          for f in glob.glob('**/*.yml', recursive=True) + glob.glob('**/*.yaml', recursive=True):
              if 'generated_' in f or '_legacy' in f or '_experiments' in f:
                  continue
              try:
                  with open(f) as fp:
                      yaml.safe_load(fp)
                  print(f'Valid: {f}')
              except Exception as e:
                  errors.append(f'{f}: {e}')
                  print(f'Invalid: {f} - {e}')

          if errors:
              sys.exit(1)
          "
          echo "All YAML files are valid"

      - name: Check directory structure
        run: |
          echo "Validating directory structure..."

          # Required directories for maestro-hive
          required_dirs=(
            "tri_audit"
            "ics"
            "tests/tri_audit"
            "infrastructure"
          )

          missing=0
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "::warning::Missing directory: $dir"
              missing=1
            else
              echo "Found: $dir"
            fi
          done

          echo "Directory structure validation complete"

      - name: Summary
        if: always()
        run: |
          echo "================================================"
          echo "Code Quality Checks Summary"
          echo "================================================"
          echo " Formatting (Black)"
          echo " Import sorting (isort)"
          echo " Linting (flake8)"
          echo " Type checking (mypy) - informational"
          echo " TODO detection - warning only"
          echo " Legacy imports check"
          echo " Large files check"
          echo " Secrets detection - warning only"
          echo " YAML validation"
          echo " Directory structure"
          echo "================================================"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-interaction
          poetry run pip install -r requirements-test.txt

      - name: Run unit tests
        run: |
          poetry run pytest tests/tri_audit/ -v --tb=short -x
        continue-on-error: false

      - name: Check test results
        run: |
          echo "================================================"
          echo "Test execution completed"
          echo "================================================"

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "Checking for potential secrets..."

          # Check for common secret patterns
          if grep -rE "(password|secret|key|token).*=.*['\"]" tri_audit/ ics/ --include="*.py" | grep -v "# " | grep -v "os."; then
            echo "::warning::Potential hardcoded secrets found - please review"
          else
            echo "No obvious secrets found"
          fi

      - name: Check .env files
        run: |
          echo "Checking .env files are not in production..."

          if [ -f "tri_audit/.env" ] || [ -f "ics/.env" ]; then
            echo "::error::.env files found in source directories - these should not be committed"
            exit 1
          fi

          echo "No .env files in source directories"

      - name: Check for private keys
        run: |
          echo "Checking for private keys..."
          if grep -rE "BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY" . --include="*.py" --include="*.pem" --include="*.key" 2>/dev/null; then
            echo "::error::Private keys found in repository"
            exit 1
          fi
          echo "No private keys found"

  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for required documentation
        run: |
          echo "Checking documentation..."

          required_docs=(
            "README.md"
            "docs/CHANGES.md"
          )

          missing=0
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "::warning::Missing: $doc"
              missing=1
            else
              echo "Found: $doc"
            fi
          done

          echo "Documentation check complete"

      - name: Check implementation logs
        run: |
          echo "Checking for implementation logs..."
          count=$(find docs/ -name "*IMPLEMENTATION_LOG.md" 2>/dev/null | wc -l)
          echo "Found $count implementation log(s)"
